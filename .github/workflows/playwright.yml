name: Playwright Tests
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
jobs:
  test:
    timeout-minutes: 30
    runs-on: ubuntu-latest
    # fow now, skip it
    # if: false
    steps:
    - uses: actions/checkout@v3

    # install node stuff
    - uses: actions/setup-node@v3
      with:
        node-version: 20
        cache: 'npm'
    - name: Install NPM dependencies
      run: npm ci

    # install python stuff
    - name: Setup python
      uses: actions/setup-python@v4
      with:
        python-version: '3.8'
        cache: 'pip'
    - name: Install Python dependencies
      run: |
        make dev-install-dependencies-pack
        make dev-install-dependencies-pack-sudo
        make dev-install-dependencies-for-development

    # build splunk application
    - name: Build Splunk Application
      run: |
        scripts/pack.sh \
          --version "9.9.9" \
          --input TA_dataset \
          --output output \
          --release release

    # run Splunk
    - name: Run Splunk
      run: |
        make docker-splunk-run-ci

    # we are fine with installing only chromium
    - name: Install Playwright Browsers
      run: npx playwright install chromium --with-deps

    - name: Run Playwright tests
      run: |
        timeout 60 sh -c 'until nc -z $0 $1; do docker ps; sleep 1; done' localhost 8000
        docker ps
        for i in `seq 1 30`; do date; nc localhost 8000; echo $?; docker ps; sleep 1; done
        npx playwright test
    - uses: actions/upload-artifact@v3
      if: always()
      with:
        name: playwright-report
        path: playwright-report/
        retention-days: 30
